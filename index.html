<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Myth AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for a modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            border: 2px solid #1e1e1e;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Styling for code blocks generated by the AI */
        pre {
            background-color: #1a1a1a;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Fira Code', monospace;
            font-size: 0.875rem;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .copy-code-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #333;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        pre:hover .copy-code-btn {
            opacity: 1;
        }

        /* Special Animated Logo for Typing Indicator */
        .typing-indicator-logo {
            width: 32px;
            height: 32px;
        }

        .typing-indicator-logo .shape {
            stroke: #60a5fa;
            /* A nice blue color */
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 2s ease-in-out infinite;
        }

        .typing-indicator-logo .shape1 {
            animation-delay: 0s;
        }

        .typing-indicator-logo .shape2 {
            animation-delay: 0.2s;
        }

        .typing-indicator-logo .shape3 {
            animation-delay: 0.4s;
        }

        @keyframes draw {
            50% {
                stroke-dashoffset: 0;
            }

            100% {
                stroke-dashoffset: -1000;
            }
        }

        /* Modal Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes scaleUp {
            from {
                transform: scale(0.95);
            }

            to {
                transform: scale(1);
            }
        }

        @keyframes scaleDown {
            from {
                transform: scale(1);
            }

            to {
                transform: scale(0.95);
            }
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out forwards;
        }

        .modal-content {
            animation: scaleUp 0.3s ease-out forwards;
        }

        .modal-closing .modal-backdrop {
            animation: fadeOut 0.3s ease-in forwards;
        }

        .modal-closing .modal-content {
            animation: scaleDown 0.3s ease-in forwards;
        }

        /* Main App Wrapper Animation */
        .view-container.visible {
            opacity: 1;
            transform: scale(1);
        }

        .view-container {
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        /* Message Actions */
        .message-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-content:hover .message-actions {
            opacity: 1;
        }

        /* Mobile Sidebar Transition */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        @media (max-width: 767px) {
            #sidebar {
                transform: translateX(-100%);
            }

            #sidebar.open {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="bg-[#101010] text-gray-200 overflow-hidden">

    <div class="absolute top-0 left-0 w-full h-full z-0 overflow-hidden">
        <div
            class="absolute -top-1/2 -left-1/2 w-[200%] h-[200%] bg-gradient-to-br from-blue-900/30 via-sky-900/10 to-transparent animate-[spin_30s_linear_infinite]">
        </div>
    </div>

    <div id="maintenance-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#101010]"
        style="display: none;">
        <h1 class="text-4xl font-bold mb-4 text-white">Under Maintenance</h1>
        <p id="maintenance-message" class="text-lg text-gray-400 text-center max-w-md px-4"></p>
    </div>

    <div id="app-wrapper" class="relative z-10 flex h-screen w-screen view-container" style="display: none;">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 md:hidden" style="display: none;"></div>

        <aside id="sidebar"
            class="bg-black/40 backdrop-blur-lg border-r border-white/10 w-72 flex-shrink-0 flex flex-col p-2 absolute md:relative h-full z-40">
            <div class="flex-shrink-0">
                <button id="new-chat-btn"
                    class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 5v14" />
                        <path d="M5 12h14" />
                    </svg>
                    New Chat
                </button>
            </div>
            <div id="chat-history-list" class="flex-grow overflow-y-auto my-4 space-y-1">
            </div>
            <div class="flex-shrink-0 border-t border-white/10 pt-2 space-y-1">
                <button id="upgrade-btn"
                    class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-blue-500/20 text-blue-400 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m15 11-4 4-4-4" />
                        <path d="m15 5-4 4-4-4" />
                    </svg>
                    Upgrade Plan
                </button>
                <div id="model-switcher-container" class="p-2">
                    <label for="model-switcher" class="text-xs text-gray-400 mb-1 block">Current Model</label>
                    <select id="model-switcher"
                        class="w-full bg-white/5 p-2 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"></select>
                </div>
                <button id="settings-btn"
                    class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 text-gray-300 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    Settings
                </button>
                <button id="logout-btn"
                    class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-red-500/20 text-red-400 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" x2="9" y1="12" y2="12" />
                    </svg>
                    Logout
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#181818]">
            <header
                class="flex-shrink-0 p-4 flex items-center justify-between border-b border-white/10 md:justify-center">
                <button id="menu-toggle-btn" class="p-2 rounded-md hover:bg-white/10 md:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 id="ai-model-name" class="text-xl font-semibold text-center">Myth AI</h1>
                <div class="w-8 md:hidden"></div>
            </header>


            <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center p-4">
                    <div id="welcome-avatar"
                        class="w-16 h-16 bg-gradient-to-br from-blue-500 to-sky-600 rounded-full flex items-center justify-center text-3xl font-bold mb-4">
                        M</div>
                    <h2 class="text-2xl md:text-3xl font-bold mb-6">How can I help you today?</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl w-full">
                        <button
                            class="welcome-prompt-btn bg-white/5 hover:bg-white/10 p-4 rounded-lg text-left transition-colors">
                            <h3 class="font-semibold">Write a Python script</h3>
                            <p class="text-sm text-gray-400">that organizes files in a directory.</p>
                        </button>
                        <button
                            class="welcome-prompt-btn bg-white/5 hover:bg-white/10 p-4 rounded-lg text-left transition-colors">
                            <h3 class="font-semibold">Explain quantum computing</h3>
                            <p class="text-sm text-gray-400">in simple terms for a beginner.</p>
                        </button>
                        <button
                            class="welcome-prompt-btn bg-white/5 hover:bg-white/10 p-4 rounded-lg text-left transition-colors">
                            <h3 class="font-semibold">Draft an email</h3>
                            <p class="text-sm text-gray-400">to a client about a project update.</p>
                        </button>
                        <button
                            class="welcome-prompt-btn bg-white/5 hover:bg-white/10 p-4 rounded-lg text-left transition-colors">
                            <h3 class="font-semibold">Tell me a joke</h3>
                            <p class="text-sm text-gray-400">about programming.</p>
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-shrink-0 p-2 md:p-4 md:px-6 border-t border-white/10">
                <div class="max-w-3xl mx-auto">
                    <div id="chat-input-container" class="relative bg-[#2a2a2a] rounded-2xl shadow-lg">
                        <textarea id="user-input" placeholder="Message Myth AI..."
                            class="w-full bg-transparent p-4 pr-24 resize-none rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow"
                            rows="1"></textarea>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-1 sm:gap-2">
                            <button id="upload-file-btn" class="p-2 rounded-full hover:bg-white/10 transition-colors"
                                title="Upload Image">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" />
                                </svg>
                                <input type="file" id="file-input-hidden" class="hidden" accept="image/*">
                            </button>
                            <button id="send-btn"
                                class="p-2 rounded-full bg-blue-600 hover:bg-blue-500 transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed"
                                title="Send Message">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="22" y1="2" x2="11" y2="13" />
                                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="stop-generating-container" class="text-center mt-4" style="display: none;">
                        <button id="stop-generating-btn"
                            class="bg-red-600/50 hover:bg-red-600/80 text-white font-semibold py-2 px-4 rounded-lg transition-colors flex items-center gap-2 mx-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                viewBox="0 0 16 16">
                                <path
                                    d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z" />
                            </svg>
                            Stop Generating
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 text-center mt-2 px-4">
                        <span>Myth AI may produce inaccurate information.</span>
                        <button id="privacy-policy-btn" class="underline hover:text-gray-300">Privacy Policy</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="admin-dashboard" class="relative z-10 h-screen w-screen p-4 view-container overflow-y-auto"
        style="display: none;">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold">Admin Dashboard</h1>
            <button id="admin-logout-btn"
                class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Logout</button>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-black/40 p-6 rounded-lg border border-white/10">
                <h2 class="text-gray-400 text-lg">Total Users</h2>
                <p id="admin-total-users" class="text-4xl font-bold">0</p>
            </div>
            <div class="bg-black/40 p-6 rounded-lg border border-white/10">
                <h2 class="text-gray-400 text-lg">Total Chats</h2>
                <p id="admin-total-chats" class="text-4xl font-bold">0</p>
            </div>
            <div class="bg-black/40 p-6 rounded-lg border border-white/10">
                <h2 class="text-gray-400 text-lg">Active Codes</h2>
                <p id="admin-active-codes" class="text-4xl font-bold">0</p>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-black/40 p-6 rounded-lg border border-white/10 lg:col-span-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Generate Promo Code</h3>
                        <div class="space-y-3">
                            <input type="text" id="new-code-name" placeholder="Code (e.g., MYTHPROMO)"
                                class="w-full p-2 bg-white/10 rounded-md border border-white/20">
                            <select id="new-code-model"
                                class="w-full p-2 bg-white/10 rounded-md border border-white/20">
                                <option value="G-4 Flash">G-4 Flash</option>
                                <option value="MYTHMAX6">MYTHMAX6</option>
                            </select>
                            <input type="datetime-local" id="new-code-expiry"
                                class="w-full p-2 bg-white/10 rounded-md border border-white/20 text-gray-400">
                            <button id="generate-code-btn"
                                class="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded-lg transition-colors">Generate</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Site Status</h3>
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-gray-300">Maintenance Mode</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="maintenance-toggle" class="sr-only peer">
                                <div
                                    class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600">
                                </div>
                            </label>
                        </div>
                        <textarea id="maintenance-message-input"
                            class="w-full p-2 bg-white/10 rounded-md border border-white/20 h-24"
                            placeholder="Set maintenance message..."></textarea>
                    </div>
                </div>
            </div>

            <div class="bg-black/40 p-6 rounded-lg border border-white/10">
                <h3 class="text-xl font-semibold mb-4">Users</h3>
                <div id="admin-user-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>
        </div>
        <div class="bg-black/40 p-6 rounded-lg border border-white/10 mt-6">
            <h3 class="text-xl font-semibold mb-4">Promo Codes</h3>
            <div class="max-h-60 overflow-y-auto">
                <table class="w-full text-left min-w-[400px]">
                    <thead>
                        <tr class="border-b border-white/20">
                            <th class="p-2">Code</th>
                            <th class="p-2">Unlocks</th>
                            <th class="p-2">Expires</th>
                            <th class="p-2"></th>
                        </tr>
                    </thead>
                    <tbody id="active-codes-table"></tbody>
                </table>
            </div>
        </div>
    </div>


    <div id="login-container"
        class="relative z-10 flex items-center justify-center h-screen w-screen p-4 view-container">
        <div class="w-full max-w-sm bg-black/40 backdrop-blur-lg border border-white/10 rounded-2xl p-8 shadow-2xl">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-white">Get Started</h2>
                <p class="text-gray-400">Continue with a provider or email</p>
            </div>
            <div class="space-y-4">
                <button id="google-login-btn"
                    class="w-full flex items-center justify-center gap-3 bg-white text-gray-800 font-semibold py-3 px-4 rounded-lg transition-transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 48 48">
                        <path fill="#FFC107"
                            d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z" />
                        <path fill="#FF3D00"
                            d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z" />
                        <path fill="#4CAF50"
                            d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z" />
                        _
                    </svg>
                    Continue with Google
                </button>
                <button id="github-login-btn"
                    class="w-full flex items-center justify-center gap-3 bg-[#333] text-white font-semibold py-3 px-4 rounded-lg transition-transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16">
                        <path fill="currentColor"
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59c.4.07.55-.17.55-.38c0-.19-.01-.82-.01-1.49c-2.01.37-2.53-.49-2.69-.94c-.09-.23-.48-.94-.82-1.13c-.28-.15-.68-.52-.01-.53c.63-.01 1.08.58 1.23.82c.72 1.21 1.87.87 2.33.66c.07-.52.28-.87.51-1.07c-1.78-.2-3.64-.89-3.64-3.95c0-.87.31-1.59.82-2.15c-.08-.2-.36-1.02.08-2.12c0 0 .67-.21 2.2.82c.64-.18 1.32-.27 2-.27c.68 0 1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82c.44 1.1.16 1.92.08 2.12c.51.56.82 1.27.82 2.15c0 3.07-1.87 3.75-3.65 3.95c.29.25.54.73.54 1.48c0 1.07-.01 1.93-.01 2.2c0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
                    </svg>
                    Continue with GitHub
                </button>
                <div class="flex items-center">
                    <div class="flex-grow border-t border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-400">or</span>
                    <div class="flex-grow border-t border-gray-600"></div>
                </div>
                <form id="email-login-form">
                    <input type="text" id="username" placeholder="Username or Email"
                        class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all mb-4"
                        required>
                    <input type="password" id="password" placeholder="Password"
                        class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all mb-4"
                        required>
                    <button id="email-continue-btn" type="submit"
                        class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-lg transition-colors">Continue
                        with Email</button>
                    <p id="login-error" class="text-red-400 text-sm text-center h-4 mt-2"></p>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-container">
        <div id="upgrade-modal" class="fixed inset-0 z-50 items-center justify-center p-4" style="display: none;">
            <div class="modal-backdrop absolute inset-0"></div>
            <div
                class="modal-content w-full max-w-md bg-[#1e1e1e] rounded-2xl p-8 shadow-2xl relative border border-white/20">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
                <h3 class="text-2xl font-bold text-center mb-2">Upgrade Your Plan</h3>
                <p class="text-center text-gray-400 mb-6">Unlock more powerful models.</p>
                <div class="space-y-4 mb-6">
                    <div class="bg-white/5 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center gap-2">
                        <div>
                            <h4 class="font-semibold">G-4 Flash</h4>
                            <p class="text-sm text-gray-400">Faster responses & interactive options.</p>
                        </div>
                        <button
                            class="buy-model-btn bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg transition-colors w-full sm:w-auto"
                            data-model="G-4 Flash">$4.99</button>
                    </div>
                    <div class="bg-white/5 p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center gap-2">
                        <div>
                            <h4 class="font-semibold">MYTHMAX6</h4>
                            <p class="text-sm text-gray-400">Advanced reasoning & creativity.</p>
                        </div>
                        <button
                            class="buy-model-btn bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg transition-colors w-full sm:w-auto"
                            data-model="MYTHMAX6">$9.99</button>
                    </div>
                </div>
                <div class="border-t border-white/20 pt-6">
                    <p class="text-center text-gray-400 mb-4">Have a code?</p>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="promo-code-input" placeholder="Enter promo code"
                            class="flex-grow p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <button id="redeem-code-btn"
                            class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition-colors">Redeem</button>
                    </div>
                    <p id="redeem-status" class="text-sm text-center h-4 mt-2"></p>
                </div>
            </div>
        </div>

        <div id="privacy-modal" class="fixed inset-0 z-50 items-center justify-center p-4" style="display: none;">
            <div class="modal-backdrop absolute inset-0"></div>
            <div
                class="modal-content w-full max-w-3xl bg-[#1e1e1e] rounded-2xl p-8 shadow-2xl relative border border-white/20 flex flex-col h-[90vh] sm:h-4/5">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
                <h3 class="text-2xl font-bold mb-4 flex-shrink-0">Privacy Policy</h3>
                <div class="text-sm text-gray-300 space-y-3 overflow-y-auto pr-4 flex-grow">
                    <p>Your privacy is important to us. It is Myth AI's policy to respect your privacy regarding any
                        information we may collect from you across our website.</p>
                    <p>We only ask for personal information when we truly need it to provide a service to you. We
                        collect it by fair and lawful means, with your knowledge and consent. We also let you know why
                        we’re collecting it and how it will be used.</p>
                    <p>We only retain collected information for as long as necessary to provide you with your requested
                        service. What data we store, we’ll protect within commercially acceptable means to prevent loss
                        and theft, as well as unauthorized access, disclosure, copying, use or modification.</p>
                    <p>We don’t share any personally identifying information publicly or with third-parties, except when
                        required to by law.</p>
                    <p>Our website may link to external sites that are not operated by us. Please be aware that we have
                        no control over the content and practices of these sites, and cannot accept responsibility or
                        liability for their respective privacy policies.</p>
                    <p>You are free to refuse our request for your personal information, with the understanding that we
                        may be unable to provide you with some of your desired services.</p>
                    <p>Your continued use of our website will be regarded as acceptance of our practices around privacy
                        and personal information. If you have any questions about how we handle user data and personal
                        information, feel free to contact us.</p>
                    <h4 class="font-semibold text-base pt-2">Chat Data</h4>
                    <p>Your chat conversations are stored in your browser's local storage to provide a continuous
                        experience. This data is not sent to our servers beyond the initial processing to generate a
                        response. Clearing your browser data will permanently delete your chat history.</p>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center p-4" style="display: none;">
            <div class="modal-backdrop absolute inset-0"></div>
            <div
                class="modal-content w-full max-w-md bg-[#1e1e1e] rounded-2xl p-8 shadow-2xl relative border border-white/20">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-white">&times;</button>
                <h3 class="text-2xl font-bold text-center mb-6">Account Settings</h3>
                <div class="space-y-4">
                    <h4 class="font-semibold text-lg border-b border-white/10 pb-2">Change Password</h4>
                    <input type="password" id="current-password" placeholder="Current Password"
                        class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <input type="password" id="new-password" placeholder="New Password"
                        class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <input type="password" id="confirm-password" placeholder="Confirm New Password"
                        class="w-full p-3 bg-white/5 rounded-lg border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <button id="change-password-btn"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition-colors">Update
                        Password</button>
                    <p id="settings-status" class="text-sm text-center h-4 mt-2"></p>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            let currentUser = null;
            let userToken = null;
            let users = {}; // This will now be a cache for user data
            let activeChatId = null;
            let isAITyping = false;
            let aiResponseTimeout = null;

            // --- DOM ELEMENTS ---
            const appWrapper = document.getElementById('app-wrapper');
            const adminDashboard = document.getElementById('admin-dashboard');
            const loginContainer = document.getElementById('login-container');
            const maintenanceScreen = document.getElementById('maintenance-screen');
            const maintenanceMessage = document.getElementById('maintenance-message');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const emailLoginForm = document.getElementById('email-login-form');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const githubLoginBtn = document.getElementById('github-login-btn');
            const loginError = document.getElementById('login-error');
            const chatWindow = document.getElementById('chat-window');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            const chatHistoryList = document.getElementById('chat-history-list');
            const welcomeScreen = document.getElementById('welcome-screen');
            const welcomeAvatar = document.getElementById('welcome-avatar');
            const aiModelName = document.getElementById('ai-model-name');
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const privacyPolicyBtn = document.getElementById('privacy-policy-btn');
            const upgradeBtn = document.getElementById('upgrade-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const upgradeModal = document.getElementById('upgrade-modal');
            const privacyModal = document.getElementById('privacy-modal');
            const settingsModal = document.getElementById('settings-modal');
            const buyModelBtns = document.querySelectorAll('.buy-model-btn');
            const promoCodeInput = document.getElementById('promo-code-input');
            const redeemCodeBtn = document.getElementById('redeem-code-btn');
            const redeemStatus = document.getElementById('redeem-status');
            const generateCodeBtn = document.getElementById('generate-code-btn');
            const activeCodesTable = document.getElementById('active-codes-table');
            const adminUserList = document.getElementById('admin-user-list');
            const maintenanceToggle = document.getElementById('maintenance-toggle');
            const maintenanceMessageInput = document.getElementById('maintenance-message-input');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const settingsStatus = document.getElementById('settings-status');
            const stopGeneratingContainer = document.getElementById('stop-generating-container');
            const stopGeneratingBtn = document.getElementById('stop-generating-btn');
            const fileInput = document.getElementById('file-input-hidden');
            const uploadFileBtn = document.getElementById('upload-file-btn');
            const modelSwitcher = document.getElementById('model-switcher');

            // --- API CONFIGURATION ---
            const API_BASE_URL = 'https://server-9awj.onrender.com/api';

            // --- UI & RENDERING ---
            const toggleSidebar = (forceClose = false) => {
                const isOpen = sidebar.classList.contains('open');
                if (forceClose || isOpen) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.style.display = 'none';
                } else {
                    sidebar.classList.add('open');
                    sidebarOverlay.style.display = 'block';
                }
            };
            const openModal = (modalElement) => {
                modalElement.style.display = 'flex';
                modalElement.classList.remove('modal-closing');
            };
            const closeModal = (modalElement) => {
                modalElement.classList.add('modal-closing');
                setTimeout(() => {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('modal-closing');
                }, 300);
            };
            const renderChatHistoryList = () => {
                chatHistoryList.innerHTML = '';
                const userChats = users[currentUser]?.chats || {};
                const sortedChatIds = Object.keys(userChats).sort((a, b) => userChats[b].timestamp - userChats[a].timestamp);

                sortedChatIds.forEach(chatId => {
                    const chat = userChats[chatId];
                    const title = chat.title || 'New Chat';
                    const button = document.createElement('button');
                    button.className = `w-full text-left p-3 rounded-lg hover:bg-white/10 transition-colors duration-200 truncate ${chatId === activeChatId ? 'bg-white/10' : ''}`;
                    button.textContent = title;
                    button.dataset.chatId = chatId;
                    button.addEventListener('click', () => {
                        activeChatId = chatId;
                        renderActiveChat();
                        renderChatHistoryList();
                        toggleSidebar(true);
                    });
                    chatHistoryList.appendChild(button);
                });
            };
            const renderActiveChat = () => {
                chatWindow.innerHTML = '';
                if (!activeChatId || !users[currentUser]?.chats[activeChatId]) {
                    welcomeAvatar.textContent = currentUser.charAt(0).toUpperCase();
                    welcomeAvatar.style.backgroundColor = users[currentUser].avatarColor;
                    welcomeScreen.style.display = 'flex';
                    aiModelName.textContent = `Myth AI`;
                    return;
                }
                welcomeScreen.style.display = 'none';
                const currentModel = users[currentUser].activeModel;
                aiModelName.textContent = `Myth AI (${currentModel})`;

                const messages = users[currentUser].chats[activeChatId].messages;
                messages.forEach(msg => addMessageToDOM(msg.sender, msg.content, msg.type, msg.options));

                chatWindow.scrollTop = chatWindow.scrollHeight;
            };
            const addMessageToDOM = (sender, content, type = 'text', options = []) => {
                const isUser = sender === 'user';
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex items-start gap-3 ${isUser ? 'justify-end' : ''}`;
                const avatar = document.createElement('div');
                avatar.className = `w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold`;
                avatar.textContent = isUser ? currentUser.charAt(0).toUpperCase() : 'M';
                avatar.style.backgroundColor = isUser ? users[currentUser].avatarColor : '#2563eb';
                const messageContent = document.createElement('div');
                messageContent.className = `message-content flex flex-col gap-2 ${isUser ? 'items-end' : 'items-start'}`;
                const messageBubble = document.createElement('div');
                messageBubble.className = `max-w-lg p-3 rounded-xl ${isUser ? 'bg-blue-700 rounded-br-none' : 'bg-[#2a2a2a] rounded-bl-none'}`;
                if (type === 'image') {
                    const img = document.createElement('img');
                    img.src = content;
                    img.className = 'max-w-xs rounded-lg';
                    messageBubble.appendChild(img);
                } else if (content.startsWith('```') && content.endsWith('```')) {
                    const code = content.slice(3, -3).trim();
                    const pre = document.createElement('pre');
                    const codeEl = document.createElement('code');
                    codeEl.textContent = code;
                    pre.appendChild(codeEl);
                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'Copy';
                    copyBtn.className = 'copy-code-btn';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(code).then(() => {
                            copyBtn.textContent = 'Copied!';
                            setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                        });
                    };
                    pre.appendChild(copyBtn);
                    messageBubble.appendChild(pre);
                } else {
                    messageBubble.innerHTML = content.replace(/\n/g, '<br>');
                }
                messageContent.appendChild(messageBubble);
                if (!isUser) {
                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'message-actions flex items-center gap-2 h-6';
                    const regenerateBtn = document.createElement('button');
                    regenerateBtn.className = 'p-1 text-gray-400 hover:text-white';
                    regenerateBtn.title = 'Regenerate response';
                    regenerateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>`;
                    regenerateBtn.onclick = async () => {
                        const lastUserMessage = users[currentUser].chats[activeChatId].messages.filter(m => m.sender === 'user').pop();
                        if (lastUserMessage) {
                            getAIResponse(lastUserMessage.content, users[currentUser].activeModel);
                        }
                    };
                    actionsContainer.appendChild(regenerateBtn);
                    messageContent.appendChild(actionsContainer);
                }
                if (options && options.length > 0) {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = `flex flex-wrap gap-2 mt-2 ${isUser ? 'justify-end' : 'justify-start'}`;
                    options.forEach(opt => {
                        const button = document.createElement('button');
                        button.textContent = opt;
                        button.className = 'bg-white/10 hover:bg-white/20 text-xs px-3 py-1 rounded-full transition-colors';
                        button.onclick = () => {
                            userInput.value = opt;
                            sendBtn.click();
                        };
                        optionsContainer.appendChild(button);
                    });
                    messageContent.appendChild(optionsContainer);
                }
                if (isUser) {
                    messageWrapper.appendChild(messageContent);
                    messageWrapper.appendChild(avatar);
                } else {
                    messageWrapper.appendChild(avatar);
                    messageWrapper.appendChild(messageContent);
                }
                chatWindow.appendChild(messageWrapper);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };
            const showTypingIndicator = () => {
                if (isAITyping) return;
                isAITyping = true;
                stopGeneratingContainer.style.display = 'flex';
                const indicatorHTML = `
                <div id="typing-indicator" class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold bg-blue-600">
                           <svg class="typing-indicator-logo" viewBox="0 0 100 100">
                                <path class="shape shape1" d="M 20,50 A 30,30 0 0,1 80,50" />
                                <path class="shape shape2" d="M 80,50 A 30,30 0 0,1 20,50" />
                                <path class="shape shape3" d="M 40,30 L 60,70 M 60,30 L 40,70" />
                            </svg>
                    </div>
                    <div class="max-w-xl p-3 rounded-xl bg-[#2a2a2a] rounded-bl-none">
                        <div class="h-6 w-24 bg-gray-600/30 rounded-md animate-pulse"></div>
                    </div>
                </div>
            `;
                chatWindow.insertAdjacentHTML('beforeend', indicatorHTML);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };
            const removeTypingIndicator = () => {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
                isAITyping = false;
                stopGeneratingContainer.style.display = 'none';
                if (aiResponseTimeout) {
                    clearTimeout(aiResponseTimeout);
                    aiResponseTimeout = null;
                }
            };
            const updateModelSwitcher = () => {
                const user = users[currentUser];
                if (!user || !user.unlockedModels) return;
                modelSwitcher.innerHTML = '';
                user.unlockedModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    if (model === user.activeModel) {
                        option.selected = true;
                    }
                    modelSwitcher.appendChild(option);
                });
            };
            
            // This function is now a placeholder. A real implementation would call the backend.
            const getAIResponse = (inputText, model) => {
                showTypingIndicator();
                const delay = 1500; 
                aiResponseTimeout = setTimeout(async () => {
                    removeTypingIndicator();
                    // In a real app, you would make a fetch call to your backend here
                    // to get a response from a real AI model.
                    const reply = { text: `This is a simulated response for the model: ${model}. In a real app, this would come from an AI.`, options: [] };
                    
                    const aiMessage = { sender: 'ai', content: reply.text, type: 'text', options: reply.options, model: model };
                    
                    // Add message to local state
                    users[currentUser].chats[activeChatId].messages.push(aiMessage);
                    addMessageToDOM('ai', reply.text, 'text', reply.options);
                    
                    // Persist to backend (fire and forget)
                    try {
                        await fetch(`${API_BASE_URL}/user/chats`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ chatId: activeChatId, message: aiMessage })
                        });
                    } catch (error) {
                        console.error("Failed to save AI message to backend:", error);
                    }
                }, delay);
            };

            const createNewChat = () => {
                const newChatId = `chat_${Date.now()}`;
                const user = users[currentUser];
                if (!user.chats) {
                    user.chats = {};
                }
                user.chats[newChatId] = {
                    id: newChatId,
                    timestamp: Date.now(),
                    title: 'New Chat',
                    messages: []
                };
                activeChatId = newChatId;
                renderActiveChat();
                renderChatHistoryList();
                toggleSidebar(true);
            };

            const summarizeChatForTitle = (chatId) => {
                const chat = users[currentUser].chats[chatId];
                if (chat && chat.messages.length > 0) {
                    const firstUserMessage = chat.messages.find(m => m.sender === 'user' && m.type === 'text');
                    if (firstUserMessage) {
                        chat.title = firstUserMessage.content.substring(0, 30) + (firstUserMessage.content.length > 30 ? '...' : '');
                    } else {
                        chat.title = 'Image Chat';
                    }
                }
            };

            // --- AUTHENTICATION ---
            const handleEmailLogin = async (event) => {
                event.preventDefault();
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                loginError.textContent = '';
                if (!username || !password) {
                    loginError.textContent = 'Username and password are required.';
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        userToken = data.token;
                        currentUser = username;
                        users[currentUser] = data.user;
                        sessionStorage.setItem('mythAI_token', userToken);
                        sessionStorage.setItem('mythAI_currentUser', currentUser);
                        startApp();
                    } else {
                        loginError.textContent = data.error || 'Login failed.';
                    }
                } catch (error) {
                    console.error("Login Error:", error);
                    loginError.textContent = 'Cannot connect to server.';
                }
            };

            const handleSocialLogin = async (provider) => {
                // This is a mock social login. Real implementation requires OAuth2.
                const username = `${provider}_user`;
                const password = `social_mock_password`;
                loginError.textContent = '';

                try {
                    // First, try to log in
                    let response = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    // If login fails (user doesn't exist), try to register
                    if (!response.ok) {
                        response = await fetch(`${API_BASE_URL}/auth/register`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password })
                        });
                    }
                    
                    const data = await response.json();

                    if (response.ok) {
                        userToken = data.token;
                        currentUser = username;
                        users[currentUser] = data.user;
                        sessionStorage.setItem('mythAI_token', userToken);
                        sessionStorage.setItem('mythAI_currentUser', currentUser);
                        startApp();
                    } else {
                        loginError.textContent = data.error || 'Social login failed.';
                    }
                } catch (error) {
                    console.error("Social Login Error:", error);
                    loginError.textContent = 'Cannot connect to server.';
                }
            };
            
            const handleLogout = (isAdminLogout = false) => {
                currentUser = null;
                activeChatId = null;
                userToken = null;
                sessionStorage.clear();
                const viewToHide = isAdminLogout ? adminDashboard : appWrapper;
                viewToHide.classList.remove('visible');
                setTimeout(() => {
                    viewToHide.style.display = 'none';
                    loginContainer.style.display = 'flex';
                    loginContainer.classList.add('visible');
                    emailLoginForm.reset();
                    loginError.textContent = '';
                }, 400);
            };

            // --- UPGRADE & ADMIN LOGIC ---
            const handlePurchase = async (modelName) => {
                alert(`In a real application, this would trigger a purchase flow for ${modelName}.`);
                closeModal(upgradeModal);
            };

            const handleRedeemCode = async () => {
                const code = promoCodeInput.value.trim().toUpperCase();
                redeemStatus.textContent = '';
                if (!code) {
                    redeemStatus.style.color = 'red';
                    redeemStatus.textContent = 'Please enter a code.';
                    return;
                }
                
                redeemStatus.textContent = 'Redeeming...';
                try {
                    const response = await fetch(`${API_BASE_URL}/user/redeem`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ code })
                    });
                    const data = await response.json();
                    if(response.ok) {
                        redeemStatus.style.color = 'lightgreen';
                        redeemStatus.textContent = data.message;
                        users[currentUser] = data.user; // Update user data with new models
                        updateModelSwitcher();
                    } else {
                        redeemStatus.style.color = 'red';
                        redeemStatus.textContent = data.error || 'Failed to redeem code.';
                    }
                } catch (error) {
                    console.error("Redeem code error:", error);
                    redeemStatus.style.color = 'red';
                    redeemStatus.textContent = 'Could not connect to server.';
                }
            };

            const renderAdminDashboard = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/admin/dashboard`, {
                        headers: { 'Authorization': `Bearer ${userToken}` }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        const { userCount, totalChats, activeCodes, users: allUsers, promoCodes: allCodes, siteStatus: currentStatus } = data;
                        document.getElementById('admin-total-users').textContent = userCount;
                        document.getElementById('admin-total-chats').textContent = totalChats;
                        document.getElementById('admin-active-codes').textContent = activeCodes;

                        adminUserList.innerHTML = '';
                        Object.keys(allUsers).filter(u => u !== 'admin').forEach(username => {
                            const div = document.createElement('div');
                            div.className = 'text-sm p-2 bg-white/5 rounded';
                            div.textContent = username;
                            adminUserList.appendChild(div);
                        });

                        activeCodesTable.innerHTML = '';
                        Object.keys(allCodes).forEach(code => {
                            const codeData = allCodes[code];
                            const expiryDate = new Date(codeData.expiry);
                            const isExpired = expiryDate < new Date();
                            const tr = document.createElement('tr');
                            tr.className = `border-b border-white/10 ${isExpired ? 'text-gray-500' : ''}`;
                            tr.innerHTML = `
                                <td class="p-2 break-all">${code}</td>
                                <td class="p-2">${codeData.model}</td>
                                <td class="p-2">${expiryDate.toLocaleString()}</td>
                                <td class="p-2 text-right"><button class="delete-code-btn text-red-400 hover:text-red-300" data-code="${code}">&times;</button></td>
                            `;
                            activeCodesTable.appendChild(tr);
                        });

                        document.querySelectorAll('.delete-code-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const codeToDelete = e.currentTarget.dataset.code;
                                await fetch(`${API_BASE_URL}/admin/promo-codes/${codeToDelete}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${userToken}` }
                                });
                                renderAdminDashboard();
                            });
                        });

                        maintenanceToggle.checked = currentStatus.isMaintenanceMode;
                        maintenanceMessageInput.value = currentStatus.message;
                    } else {
                        alert('Failed to load admin data: ' + data.error);
                    }
                } catch (error) {
                    console.error('Admin Dashboard Error:', error);
                    alert('Could not connect to backend for admin data.');
                }
            };

            // --- INITIALIZATION ---
            const initApp = () => {
                loginContainer.style.display = 'none';
                loginContainer.classList.remove('visible');
                maintenanceScreen.style.display = 'none';

                if (users[currentUser]?.role === 'admin') {
                    appWrapper.style.display = 'none';
                    adminDashboard.style.display = 'block';
                    setTimeout(() => adminDashboard.classList.add('visible'), 50);
                    renderAdminDashboard();
                } else {
                    adminDashboard.style.display = 'none';
                    appWrapper.style.display = 'flex';
                    setTimeout(() => appWrapper.classList.add('visible'), 50);

                    const user = users[currentUser];
                    if (!user.chats) user.chats = {};
                    
                    const chatIds = Object.keys(user.chats);
                    activeChatId = chatIds.length > 0 ? chatIds.sort((a, b) => user.chats[b].timestamp - user.chats[a].timestamp)[0] : null;

                    updateModelSwitcher();
                    renderChatHistoryList();
                    renderActiveChat();
                }
            };

            // --- EVENT LISTENERS ---
            emailLoginForm.addEventListener('submit', handleEmailLogin);
            googleLoginBtn.addEventListener('click', () => handleSocialLogin('google'));
            githubLoginBtn.addEventListener('click', () => handleSocialLogin('github'));
            logoutBtn.addEventListener('click', () => handleLogout(false));
            adminLogoutBtn.addEventListener('click', () => handleLogout(true));
            newChatBtn.addEventListener('click', () => {
                if (currentUser === 'admin') return;
                createNewChat();
            });
            const handleSendMessage = async (content, type = 'text') => {
                if ((type === 'text' && !content.trim()) || isAITyping) return;
                
                const isNewChat = !activeChatId;
                if (isNewChat) createNewChat();
                
                const currentModel = users[currentUser].activeModel;
                const message = { sender: 'user', content: content, type: type, model: currentModel };
                
                // Add message to local state first for instant UI update
                users[currentUser].chats[activeChatId].messages.push(message);
                if (isNewChat) {
                    summarizeChatForTitle(activeChatId);
                    renderChatHistoryList();
                }
                addMessageToDOM('user', content, type);
                userInput.value = '';
                userInput.style.height = 'auto';
                userInput.focus();
                
                // Then, send to backend
                try {
                    await fetch(`${API_BASE_URL}/user/chats`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ chatId: activeChatId, message: message })
                    });
                } catch (error) {
                    console.error("Failed to save user message to backend:", error);
                    // Optionally, show an error to the user
                }

                getAIResponse(type === 'image' ? '[Image Received]' : content, currentModel);
            };
            sendBtn.addEventListener('click', () => handleSendMessage(userInput.value.trim()));
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendBtn.click();
                }
            });
            userInput.addEventListener('input', () => {
                userInput.style.height = 'auto';
                const scrollHeight = userInput.scrollHeight;
                const maxHeight = 5 * parseFloat(getComputedStyle(userInput).lineHeight);
                userInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
            });
            menuToggleBtn.addEventListener('click', () => toggleSidebar());
            sidebarOverlay.addEventListener('click', () => toggleSidebar(true));
            upgradeBtn.addEventListener('click', () => openModal(upgradeModal));
            privacyPolicyBtn.addEventListener('click', () => openModal(privacyModal));
            settingsBtn.addEventListener('click', async () => {
                settingsStatus.textContent = '';
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                openModal(settingsModal);
            });
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    closeModal(e.currentTarget.closest('.fixed'));
                });
            });
            buyModelBtns.forEach(btn => btn.addEventListener('click', (e) => handlePurchase(e.target.dataset.model)));
            redeemCodeBtn.addEventListener('click', handleRedeemCode);
            
            // This is a mock implementation, as password changes should be handled by the backend
            changePasswordBtn.addEventListener('click', async () => {
                settingsStatus.style.color = 'lightgreen';
                settingsStatus.textContent = 'Password change is not implemented in this demo.';
            });
            
            generateCodeBtn.addEventListener('click', async () => {
                const name = document.getElementById('new-code-name').value.trim().toUpperCase();
                const model = document.getElementById('new-code-model').value;
                const expiry = document.getElementById('new-code-expiry').value;
                if (name && expiry) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/admin/promo-codes`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${userToken}`
                            },
                            body: JSON.stringify({ code: name, model, expiry })
                        });
                        const data = await response.json();
                        if (response.ok) {
                            renderAdminDashboard();
                            document.getElementById('new-code-name').value = '';
                        } else {
                            alert(data.error || 'Failed to generate code.');
                        }
                    } catch (error) {
                        alert('Failed to generate code.');
                    }
                } else {
                    alert('Please fill in all fields for the code.');
                }
            });

            modelSwitcher.addEventListener('change', async (e) => {
                users[currentUser].activeModel = e.target.value;
                // In a real app, this would also be saved to the backend
                renderActiveChat();
            });

            stopGeneratingBtn.addEventListener('click', removeTypingIndicator);
            document.querySelectorAll('.welcome-prompt-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const promptText = btn.querySelector('h3').textContent.trim() + " " + btn.querySelector('p').textContent.trim();
                    userInput.value = promptText;
                    userInput.focus();
                    sendBtn.click();
                });
            });
            uploadFileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        handleSendMessage(event.target.result, 'image');
                    };
                    reader.readAsDataURL(file);
                } else if (file) {
                    alert('Only image files are supported at this time.');
                }
                fileInput.value = '';
            });
            
            const updateMaintenanceStatus = async () => {
                const isMaintenanceMode = maintenanceToggle.checked;
                const message = maintenanceMessageInput.value;
                try {
                    await fetch(`${API_BASE_URL}/admin/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        },
                        body: JSON.stringify({ isMaintenanceMode, message })
                    });
                } catch (error) {
                    console.error('Failed to update maintenance status:', error);
                }
            };
            maintenanceToggle.addEventListener('change', updateMaintenanceStatus);
            maintenanceMessageInput.addEventListener('input', updateMaintenanceStatus);

            // --- APP START ---
            const initialLoad = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/status`);
                    const statusData = await response.json();
                    
                    userToken = sessionStorage.getItem('mythAI_token');
                    currentUser = sessionStorage.getItem('mythAI_currentUser');

                    if (statusData.isMaintenanceMode && (!userToken || JSON.parse(atob(userToken.split('.')[1])).role !== 'admin')) {
                        maintenanceMessage.textContent = statusData.message;
                        maintenanceScreen.style.display = 'flex';
                        loginContainer.style.display = 'none';
                        return;
                    }

                    if (userToken && currentUser) {
                        // Validate token and get user data
                        const userResponse = await fetch(`${API_BASE_URL}/user/data`, {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        if (userResponse.ok) {
                            users[currentUser] = await userResponse.json();
                            startApp();
                        } else {
                            // Token is invalid/expired
                            handleLogout();
                        }
                    } else {
                        loginContainer.style.display = 'flex';
                        setTimeout(() => loginContainer.classList.add('visible'), 50);
                    }
                } catch (error) {
                    console.error("Initial Load Error:", error);
                    loginContainer.style.display = 'flex';
                    loginError.textContent = 'Could not connect to the server. Please try again later.';
                    setTimeout(() => loginContainer.classList.add('visible'), 50);
                }
            };

            initialLoad();
        });
    </script>
</body>

</html>
